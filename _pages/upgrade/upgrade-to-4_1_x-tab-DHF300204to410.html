<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Begin Jekyll SEO tag v2.3.0 -->
<title>marklogic-data-hub</title>
<meta property="og:title" content="marklogic-data-hub" />
<meta property="og:locale" content="en_US" />
<meta property="og:site_name" content="marklogic-data-hub" />
<script type="application/ld+json">
{"name":null,"description":null,"author":null,"@type":"WebPage","url":"/marklogic-data-hub/_pages/upgrade/upgrade-to-4_1_x-tab-DHF300204to410","image":null,"publisher":null,"headline":"marklogic-data-hub","dateModified":null,"datePublished":null,"sameAs":null,"mainEntityOfPage":null,"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->

    <link href="/marklogic-data-hub/assets/css/style.css?v=f2365033c5171e30c9b8fe0dc1eb715e947395f0" rel="stylesheet">
  </head>
  <body>
    <div class="container-lg px-3 my-5 markdown-body">
      
        <h1><a href="/marklogic-data-hub/">marklogic-data-hub</a></h1>
      

      <div id="DHF300204to410" class="tabcontent">

  <p>The notes and steps in this tab are for the following upgrade paths:</p>
  <ul>
    <li>DHF 3.0.0 » 4.1.x or 4.2.x</li>
    <li>DHF 2.0.6 » 4.1.x or 4.2.x</li>
    <li>DHF 2.0.5 » 4.1.x or 4.2.x</li>
    <li>DHF 2.0.4 » 4.1.x or 4.2.x</li>
  </ul>

  <h3 id="upgrade-notes">Upgrade Notes</h3>

  <ul>
    <li>
      <p>The <code class="highlighter-rouge">hubUpdate</code> Gradle task makes the following changes.</p>

      <ul>
        <li>
          <p>Renames old configuration directories under your project root.</p>

          <table class="table-b1gray">
            <thead>
              <tr>
                <th>old directory</th>
                <th>new directory</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><code class="highlighter-rouge">hub-internal-config</code></td>
                <td><code class="highlighter-rouge">hub-internal-config.old</code></td>
              </tr>
              <tr>
                <td><code class="highlighter-rouge">user-config</code></td>
                <td><code class="highlighter-rouge">user-config.old</code></td>
              </tr>
              <tr>
                <td><code class="highlighter-rouge">entity-config</code></td>
                <td><code class="highlighter-rouge">entity-config.old</code></td>
              </tr>
            </tbody>
          </table>
        </li>
        <li>
          <p>Creates the new project directory structure (<code class="highlighter-rouge">your-project-root/src/main</code> and its subdirectories) and new files.</p>
        </li>
        <li>
          <p>Copies some settings from the old configuration files to the new ones.</p>
        </li>
        <li>
          <p>Updates all flows to use updated imports. See the [notes to upgrade to 4.0.0] ](https://marklogic.github.io/marklogic-data-hub/upgrade/upgrade-to-4_0_x/#upgrading-from-204-to-40x).</p>
        </li>
      </ul>
    </li>
    <li>
      <p>Running the <code class="highlighter-rouge">hubUpdate</code> task with the <code class="highlighter-rouge">-i</code> option (info mode) displays specifically what the task does, including configuration settings that changed.</p>

      <details><summary><b>Example:</b> A verbose report.</summary>
  <pre>
  Upgrading entity-config dir
  Upgrading hub-internal-config dir
  Processing /your-project-root/hub-internal-config/databases/job-database.json
  Setting "schema-database" to "%%mlStagingSchemasDbName%%"
  Setting "triggers-database" to "%%mlStagingTriggersDbName%%"
  Adding path range indexes to job-database.json
  Writing /your-project-root/hub-internal-config/databases/job-database.json to /your-project-root/src/main/hub-internal-config/databases/job-database.json
  Processing /your-project-root/hub-internal-config/databases/final-database.json
  Setting "schema-database" to "%%mlFinalSchemasDbName%%"
  Setting "triggers-database" to "%%mlFinalTriggersDbName%%"
  Writing /your-project-root/hub-internal-config/databases/final-database.json to /your-project-root/src/main/ml-config/databases/final-database.json
  Processing /your-project-root/hub-internal-config/databases/staging-database.json
  Setting "schema-database" to "%%mlStagingSchemasDbName%%"
  Setting "triggers-database" to "%%mlStagingTriggersDbName%%"
  Writing /your-project-root/hub-internal-config/databases/staging-database.json to /your-project-root/src/main/hub-internal-config/databases/staging-database.json
  Writing /your-project-root/hub-internal-config/databases/modules-database.json to /your-project-root/src/main/ml-config/databases/modules-database.json
  Processing /your-project-root/hub-internal-config/servers/job-server.json
  Setting "url-rewriter" to "/data-hub/4/tracing/tracing-rewriter.xml"
  Writing /your-project-root/hub-internal-config/servers/job-server.json to /your-project-root/src/main/hub-internal-config/servers/job-server.json
  Writing /your-project-root/hub-internal-config/servers/final-server.json to /your-project-root/src/main/ml-config/servers/final-server.json
  Processing /your-project-root/hub-internal-config/servers/staging-server.json
  Setting "url-rewriter" to "/data-hub/4/rest-api/rewriter.xml"
  Setting "error-handler" to "/data-hub/4/rest-api/error-handler.xqy"
  Writing /your-project-root/hub-internal-config/servers/staging-server.json to /your-project-root/src/main/hub-internal-config/servers/staging-server.json
  Upgrading user-config dir
  </pre>
</details>
    </li>
    <li>
      <p>If custom configurations (i.e., from <code class="highlighter-rouge">user-config</code>) are missing, you must manually copy them to <code class="highlighter-rouge">ml-config</code>.</p>
    </li>
    <li>
      <p>Because DHF 3.0.0 and DHF 2.0.4+ had only a single schemas database and a single triggers database, you must decide whether to use those existing databases as the staging databases or as the final databases in DHF 4.1.0. The settings in <code class="highlighter-rouge">gradle.properties</code> (and possibly other configurations) depend on your decision.</p>

      <table class="table-b1gray">
        <thead>
          <tr>
            <th>DHF 3.0.0 and 2.0.4+</th>
            <th>DHF 4.x</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><code class="highlighter-rouge">data-hub-SCHEMAS</code> database</td>
            <td><code class="highlighter-rouge">data-hub-staging-SCHEMAS</code> database<br /><code class="highlighter-rouge">data-hub-final-SCHEMAS</code> database</td>
          </tr>
          <tr>
            <td><code class="highlighter-rouge">data-hub-TRIGGERS</code> dtabase</td>
            <td><code class="highlighter-rouge">data-hub-staging-TRIGGERS</code> database<br /><code class="highlighter-rouge">data-hub-final-TRIGGERS</code> database</td>
          </tr>
        </tbody>
      </table>
    </li>
  </ul>

  <!--
- In 4.0.0, the return type for plugins was changed to `objectNode()`. If your custom plugins contains lines that convert a plugin parameter using `.toObject()`, those lines of code must be removed or commented out.

    **Examples:**
        - `content = content.toObject()` in header.sjs under input directory
        - `envelope = envelope.toObject()` in writer.sjs under harmonize directory
-->

  <h3 id="procedure">Procedure</h3>

  <ol class="ol-steps">
    <li>
      <p>In your <code class="highlighter-rouge">build.gradle</code> file, replace all occurrences of your old DHF version number with <code class="highlighter-rouge">4.1.1</code>.</p>

      <p><strong>Example:</strong> In the <code class="highlighter-rouge">plugins</code> section and the <code class="highlighter-rouge">dependencies</code> section,</p>

      <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   plugins {
       id 'net.saliman.properties' version '1.4.6'
       id 'com.marklogic.ml-data-hub' version '4.1.1'
   }
   ...
   dependencies {
     compile 'com.marklogic:marklogic-data-hub:4.1.1'
     compile 'com.marklogic:marklogic-xcc:9.0.6'
   }
</code></pre></div>      </div>
    </li>
    <li>
      <p>At your project’s root folder, run the <code class="highlighter-rouge">hubUpdate -i</code> Gradle task.</p>

      <div class="code-tabs">
     <ul class="nav nav-tabs" role="tablist">
       <li role="presentation" class="active">
         <a role="tab" aria-controls="tab1-1" href="#tab1-1">Unix Systems</a>
       </li>
       <li role="presentation" class="">
         <a role="tab" aria-controls="tab2-1" href="#tab2-1">Windows</a>
       </li>
     </ul>
     <div class="tab-content">
       <div role="tabpanel" class="tab-pane active" id="tab1-1">
         <pre class="cmdline">./gradlew hubUpdate -i</pre>
       </div>
       <div role="tabpanel" class="tab-pane" id="tab2-1">
         <pre class="cmdline">gradlew.bat hubUpdate -i</pre>
       </div>
     </div>
   </div>
    </li>
    <li>
      <p>Edit your <code class="highlighter-rouge">gradle.properties</code> file.</p>

      <p>a. Remove the following properties: <!-- What are the actual names? --></p>

      <ul>
        <li>data-hub-TRACING server</li>
        <li>data-hub-TRACING database</li>
        <li>data-hub-TRIGGERS database</li>
        <li>data-hub-SCHEMAS database</li>
      </ul>

      <p>b. Add the following properties and replace the values accordingly.</p>

      <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   mlDHFVersion=4.1.0
   mlStagingTriggersDbName=data-hub-staging-TRIGGERS
   mlStagingTriggersForestsPerHost=1
   mlStagingSchemasDbName=data-hub-staging-SCHEMAS
   mlStagingSchemasForestsPerHost=1
   mlFinalTriggersDbName=data-hub-final-TRIGGERS
   mlFinalTriggersForestsPerHost=1
   mlFinalSchemasDbName=data-hub-final-SCHEMAS
   mlFinalSchemasForestsPerHost=1
   mlHubAdminRole=hub-admin-role
   mlHubAdminUserName=hub-admin-user
</code></pre></div>      </div>

      <p>c. Add default modules permissions.</p>

      <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   mlModulePermissions=rest-reader,read,rest-writer,insert,rest-writer,update,rest-extension-user,execute,data-hub-role,read,data-hub-role,execute
</code></pre></div>      </div>
    </li>
    <li>
      <p>At your project’s root folder, run the <code class="highlighter-rouge">mlDeploy</code> Gradle task.</p>

      <div class="code-tabs">
     <ul class="nav nav-tabs" role="tablist">
       <li role="presentation" class="active">
         <a role="tab" aria-controls="tab1-2" href="#tab1-2">Unix Systems</a>
       </li>
       <li role="presentation" class="">
         <a role="tab" aria-controls="tab2-2" href="#tab2-2">Windows</a>
       </li>
     </ul>
     <div class="tab-content">
       <div role="tabpanel" class="tab-pane active" id="tab1-2">
         <pre class="cmdline">./gradlew mlDeploy</pre>
       </div>
       <div role="tabpanel" class="tab-pane" id="tab2-2">
         <pre class="cmdline">gradlew.bat mlDeploy</pre>
       </div>
     </div>
   </div>
    </li>
    <li>
      <p>Run your <a href="/marklogic-data-hub/ingest/">ingest</a> and <a href="/marklogic-data-hub/harmonize/">harmonize</a> flows.</p>

      <p>If you use <a href="https://docs.marklogic.com/guide/mlcp">MarkLogic Content Pump</a> for your input flows, run MLCP with the <code class="highlighter-rouge">-transform_module</code> option as follows:</p>

      <div class="code-tabs">
     <ul class="nav nav-tabs" role="tablist">
       <li role="presentation" class="active">
         <a role="tab" aria-controls="tab1-3" href="#tab1-3">XQuery plugin (.xqy)</a>
       </li>
       <li role="presentation" class="">
         <a role="tab" aria-controls="tab2-3" href="#tab2-3">JavaScript plugin (.sjs)</a>
       </li>
     </ul>
     <div class="tab-content">
       <div role="tabpanel" class="tab-pane active" id="tab1-3">
         <pre class="cmdline">-transform_module "/data-hub/4/transforms/mlcp-flow-transform.xqy"</pre>
       </div>
       <div role="tabpanel" class="tab-pane" id="tab2-3">
         <pre class="cmdline">-transform_module "/data-hub/4/transforms/mlcp-flow-transform.sjs"</pre>
       </div>
     </div>
   </div>
    </li>
  </ol>

  <h3 id="remarks">Remarks</h3>

  <p>Before running <code class="highlighter-rouge">mlUndeploy</code>, delete the resources associated with the properties that were removed from the <code class="highlighter-rouge">gradle.properties</code> file:</p>

  <ul>
    <li>data-hub-TRACING server</li>
    <li>data-hub-TRACING database</li>
    <li>data-hub-TRIGGERS database</li>
    <li>data-hub-SCHEMAS database</li>
  </ul>

  <!-- To undeploy, "./gradlew mlUndeploy -Pconfirm=true" -->
</div>


      
    </div>
    <script src="/marklogic-data-hub/assets/javascript/anchor-js/anchor.min.js"></script>
    <script>anchors.add();</script>
  </body>
</html>
